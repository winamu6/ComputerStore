@model ComputerStore.Web.Models.PaymentViewModel
@{
    ViewData["Title"] = "Оплата заказа";
}

<div class="container py-4">
    <h2 class="mb-4">Оплата заказа #@Model.Order.OrderNumber</h2>

    <div class="row">
        <!-- Payment Form -->
        <div class="col-lg-8">
            @if (Model.Order.PaymentMethod == ComputerStore.Domain.Enums.PaymentMethod.Cash)
            {
                <!-- Cash Payment -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-cash-coin"></i> Оплата наличными при получении
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Оплата при получении</strong><br />
                            Вы сможете оплатить заказ наличными при получении товара.
                        </div>

                        <p class="mb-3">Детали заказа:</p>
                        <ul>
                            <li><strong>Номер заказа:</strong> @Model.Order.OrderNumber</li>
                            <li><strong>Сумма к оплате:</strong> <strong class="text-success">$@Model.Order.TotalAmount.ToString("N2")</strong></li>
                            <li><strong>Адрес доставки:</strong> @Model.Order.ShippingAddress, @Model.Order.ShippingCity</li>
                        </ul>

                        <form asp-action="ProcessCash" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="orderId" value="@Model.Order.Id" />
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> Подтвердить заказ
                                </button>
                                <a asp-controller="Orders" asp-action="Details" asp-route-id="@Model.Order.Id" 
                                   class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Назад к заказу
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <!-- Card Payment -->
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-credit-card"></i> Оплата картой
                        </h5>
                    </div>
                    <div class="card-body">
                        <form asp-action="ProcessCard" method="post" id="paymentForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="PaymentId" value="@Model.Payment.Id" />

                            <div class="mb-3">
                                <label for="CardNumber" class="form-label">Номер карты*</label>
                                <input type="text" class="form-control" id="CardNumber" name="CardNumber" 
                                       placeholder="1234 5678 9012 3456" maxlength="19" required 
                                       pattern="[0-9]{13,19}" />
                                <small class="text-muted">Введите номер карты без пробелов</small>
                            </div>

                            <div class="mb-3">
                                <label for="CardHolderName" class="form-label">Имя держателя карты*</label>
                                <input type="text" class="form-control" id="CardHolderName" name="CardHolderName" 
                                       placeholder="IVAN IVANOV" required />
                                <small class="text-muted">Как указано на карте</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="ExpiryDate" class="form-label">Срок действия*</label>
                                    <input type="text" class="form-control" id="ExpiryDate" name="ExpiryDate" 
                                           placeholder="MM/YY" maxlength="5" required pattern="[0-9]{2}/[0-9]{2}" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="CVV" class="form-label">CVV*</label>
                                    <input type="text" class="form-control" id="CVV" name="CVV" 
                                           placeholder="123" maxlength="4" required pattern="[0-9]{3,4}" />
                                    <small class="text-muted">3-4 цифры на обороте карты</small>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <i class="bi bi-shield-check"></i>
                                <strong>Безопасная оплата</strong><br />
                                Все данные передаются по защищенному соединению.
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="bi bi-lock"></i> Оплатить $@Model.Order.TotalAmount.ToString("N2")
                                </button>
                                <a asp-controller="Orders" asp-action="Details" asp-route-id="@Model.Order.Id" 
                                   class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Назад к заказу
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Accepted Cards -->
                <div class="card mt-3">
                    <div class="card-body text-center">
                        <small class="text-muted">Принимаем к оплате:</small><br />
                        <i class="bi bi-credit-card fs-3 mx-2"></i>
                        <i class="bi bi-credit-card-2-front fs-3 mx-2"></i>
                    </div>
                </div>
            }
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card shadow sticky-top" style="top: 20px;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Детали заказа</h5>
                </div>
                <div class="card-body">
                    <p><strong>Заказ:</strong> #@Model.Order.OrderNumber</p>
                    <p><strong>Дата:</strong> @Model.Order.OrderDate.ToString("dd.MM.yyyy")</p>
                    
                    <hr />
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Товары:</span>
                        <strong>$@Model.Order.SubTotal.ToString("N2")</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Доставка:</span>
                        <strong>$@Model.Order.ShippingCost.ToString("N2")</strong>
                    </div>
                    
                    @if (Model.Order.DiscountAmount.HasValue && Model.Order.DiscountAmount > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Скидка:</span>
                            <strong>-$@Model.Order.DiscountAmount.Value.ToString("N2")</strong>
                        </div>
                    }
                    
                    <hr />
                    
                    <div class="d-flex justify-content-between">
                        <h5>Итого:</h5>
                        <h5 class="text-primary">$@Model.Order.TotalAmount.ToString("N2")</h5>
                    </div>
                    
                    <hr />
                    
                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle"></i>
                        После оплаты ваш заказ будет передан в обработку.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Форматирование номера карты
        document.getElementById('CardNumber')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            e.target.value = value;
        });
        
        // Форматирование даты
        document.getElementById('ExpiryDate')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
        
        // Блокировка повторной отправки
        document.getElementById('paymentForm')?.addEventListener('submit', function() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Обработка...';
        });
    </script>
}