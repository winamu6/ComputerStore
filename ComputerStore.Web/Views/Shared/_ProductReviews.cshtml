@model IEnumerable<ComputerStore.Shared.DTOs.ReviewDto>
@{
    var reviews = Model.ToList();
    var productId = ViewBag.ProductId as int? ?? 0;
    var averageRating = reviews.Any() ? reviews.Average(r => r.Rating) : 0;
    var totalReviews = reviews.Count;
}

<!-- Reviews Section -->
<div class="card shadow mb-4" id="reviews-section">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-star-fill text-warning"></i> Отзывы покупателей
            @if (totalReviews > 0)
            {
                <span class="text-muted">(@totalReviews)</span>
            }
        </h5>
        @if (User.Identity?.IsAuthenticated == true)
        {
            <a asp-controller="Reviews" asp-action="Create" asp-route-productId="@productId" 
               class="btn btn-warning">
                <i class="bi bi-plus-circle"></i> Написать отзыв
            </a>
        }
        else
        {
            <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-warning">
                <i class="bi bi-box-arrow-in-right"></i> Войдите, чтобы оставить отзыв
            </a>
        }
    </div>
    <div class="card-body">
        @if (reviews.Any())
        {
            <!-- Rating Summary -->
            <div class="row mb-4 pb-4 border-bottom">
                <div class="col-md-3 text-center">
                    <div class="display-3 text-warning fw-bold">@averageRating.ToString("N1")</div>
                    <div class="mb-2">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= Math.Floor(averageRating))
                            {
                                <i class="bi bi-star-fill text-warning fs-5"></i>
                            }
                            else if (i - 0.5 <= averageRating)
                            {
                                <i class="bi bi-star-half text-warning fs-5"></i>
                            }
                            else
                            {
                                <i class="bi bi-star text-warning fs-5"></i>
                            }
                        }
                    </div>
                    <small class="text-muted">На основе @totalReviews отзывов</small>
                </div>
                
                <div class="col-md-9">
                    <!-- Rating Bars -->
                    @for (int star = 5; star >= 1; star--)
                    {
                        var count = reviews.Count(r => r.Rating == star);
                        var percentage = totalReviews > 0 ? (count * 100.0 / totalReviews) : 0;
                        
                        <div class="d-flex align-items-center mb-2">
                            <span class="me-2" style="width: 60px;">@star ★</span>
                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                <div class="progress-bar bg-warning" role="progressbar" 
                                     style="width: @percentage%" 
                                     aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span class="text-muted" style="width: 80px;">@count (@percentage.ToString("N0")%)</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Reviews List -->
            <div class="reviews-list">
                @foreach (var review in reviews.OrderByDescending(r => r.CreatedAt))
                {
                    <div class="review-item mb-4 pb-4 border-bottom">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>@review.CustomerName</strong>
                                @if (review.IsVerifiedPurchase)
                                {
                                    <span class="badge bg-success ms-2">
                                        <i class="bi bi-check-circle"></i> Подтверждённая покупка
                                    </span>
                                }
                            </div>
                            <small class="text-muted">@review.CreatedAt.ToString("dd.MM.yyyy")</small>
                        </div>

                        <!-- Rating Stars -->
                        <div class="mb-2">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= review.Rating)
                                {
                                    <i class="bi bi-star-fill text-warning"></i>
                                }
                                else
                                {
                                    <i class="bi bi-star text-warning"></i>
                                }
                            }
                        </div>

                        <!-- Title -->
                        <h6 class="mb-2">@review.Title</h6>

                        <!-- Comment -->
                        <p class="mb-3">@review.Comment</p>

                        <!-- Helpful Buttons -->
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-sm btn-outline-secondary helpful-btn" 
                                    data-review-id="@review.Id" data-helpful="true">
                                <i class="bi bi-hand-thumbs-up"></i> Полезно (@review.HelpfulCount)
                            </button>
                            <button class="btn btn-sm btn-outline-secondary helpful-btn" 
                                    data-review-id="@review.Id" data-helpful="false">
                                <i class="bi bi-hand-thumbs-down"></i> Не полезно (@review.NotHelpfulCount)
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="bi bi-chat-left-text display-1 text-muted"></i>
                <h5 class="mt-3 text-muted">Пока нет отзывов</h5>
                <p class="text-muted">Будьте первым, кто оставит отзыв об этом товаре</p>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <a asp-controller="Reviews" asp-action="Create" asp-route-productId="@productId" 
                       class="btn btn-warning">
                        <i class="bi bi-plus-circle"></i> Написать первый отзыв
                    </a>
                }
                else
                {
                    <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-warning">
                        Войти и оставить отзыв
                    </a>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.helpful-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const reviewId = this.dataset.reviewId;
                const helpful = this.dataset.helpful === 'true';
                
                try {
                    const response = await fetch('@Url.Action("MarkHelpful", "Reviews")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: JSON.stringify({ reviewId: parseInt(reviewId), helpful: helpful })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            // Обновляем счётчик
                            const currentCount = parseInt(this.textContent.match(/\d+/)[0]);
                            this.innerHTML = helpful 
                                ? `<i class="bi bi-hand-thumbs-up"></i> Полезно (${currentCount + 1})`
                                : `<i class="bi bi-hand-thumbs-down"></i> Не полезно (${currentCount + 1})`;
                            
                            // Отключаем кнопку
                            this.disabled = true;
                            this.classList.add('disabled');
                        }
                    }
                } catch (error) {
                    console.error('Error marking review as helpful:', error);
                }
            });
        });
    </script>
}